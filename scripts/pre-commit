#!/bin/sh
#
# Pre-commit hook - Runs quality checks before allowing commit
# Install: cp scripts/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
#

echo "üîç Running pre-commit checks..."
echo ""

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$')

if [ -z "$STAGED_FILES" ]; then
  echo "No TypeScript/JavaScript files staged, skipping checks."
  exit 0
fi

# 1. TypeScript Check
echo "üìã TypeScript compilation..."
if ! pnpm run typecheck; then
  echo "‚ùå TypeScript check failed. Fix errors before committing."
  exit 1
fi

# 2. Lint staged files
echo "üßπ Linting..."
if ! pnpm run lint; then
  echo "‚ùå Linting failed. Fix errors before committing."
  exit 1
fi

# 3. Run related tests
echo "üß™ Running tests..."
if ! pnpm run test --passWithNoTests --bail; then
  echo "‚ùå Tests failed. Fix them before committing."
  exit 1
fi

# 4. Check for console.log (warning only)
CONSOLE_LOGS=$(echo "$STAGED_FILES" | xargs grep -l "console\.log" 2>/dev/null | grep -v ".test." | grep -v ".spec.")
if [ -n "$CONSOLE_LOGS" ]; then
  echo "‚ö†Ô∏è  Warning: console.log found in:"
  echo "$CONSOLE_LOGS"
  echo ""
fi

# 5. Check for TODO/FIXME (warning only)
TODOS=$(echo "$STAGED_FILES" | xargs grep -l "TODO\|FIXME" 2>/dev/null)
if [ -n "$TODOS" ]; then
  echo "‚ö†Ô∏è  Warning: TODO/FIXME found in:"
  echo "$TODOS"
  echo ""
fi

echo "‚úÖ Pre-commit checks passed!"
exit 0
